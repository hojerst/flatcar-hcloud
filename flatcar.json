{
  "variables": {
    "location": "nbg1",
    "server_type": "cx21",
    "snapshot_prefix": "flatcar-hcloud",
    "image_type": "generic",
    "grub_config": "grub.cfg"
  },
  "builders": [
    {
      "type": "hcloud",
      "image": "ubuntu-18.04",
      "location": "{{user `location`}}",
      "server_type": "{{user `server_type`}}",
      "ssh_username": "root",
      "rescue": "linux64",
      "snapshot_name": "{{user `snapshot_prefix`}}-{{timestamp}}",
      "snapshot_labels": {
        "os": "flatcar",
        "image_type": "{{user `image_type`}}"
      }
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "inline": [
        "set -x",
        "curl -fsSLO https://stable.release.flatcar-linux.net/amd64-usr/current/flatcar_production_qemu_image.img.bz2",
        "bunzip2 flatcar_production_qemu_image.img.bz2",
        "qemu-img convert flatcar_production_qemu_image.img -O raw /dev/sda",
        "mount /dev/sda6 /mnt"
      ]
    },
    {
      "type": "file",
      "source": "{{user `grub_config`}}",
      "destination": "/mnt/grub.cfg"
    },
    {
      "type": "shell",
      "inline": [
        "set -x",
        "umount /mnt"
      ]
    }
  ]
}
